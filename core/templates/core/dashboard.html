{% extends 'core/base.html' %}

{% block content %}
<style>
    /* Game Canvas Styling */
    #gameCanvas {
        background-color: #0f1115; /* Very dark background */
        border: 2px solid #2d323e;
        border-radius: 8px;
        display: none; /* Hidden until start */
        margin: 0 auto;
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.1);
    }
    .game-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: white;
        pointer-events: none; /* Let clicks pass through if needed */
    }
</style>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card shadow-sm border-0" style="background-color: #1e222b; border: 1px solid #2d323e;">
            <div class="card-body text-center p-4">
                <div class="mb-3">
                    <div style="width: 100px; height: 100px; background-color: #0d6efd; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto; font-weight: bold;">
                        {{ user.first_name|first|default:user.email|first|upper }}
                    </div>
                </div>
                <h4 class="text-white mb-1">
                    {% if user.first_name %}{{ user.first_name }} {{ user.last_name }}{% else %}Student{% endif %}
                </h4>
                <p class="text-muted mb-3">{{ user.email }}</p>
                <div class="d-grid">
                    <a href="#" class="btn btn-outline-light btn-sm">Edit Profile</a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <h3 class="text-white mb-4">My Enrolled Courses</h3>

        <!-- Fee Status Card -->
        <div class="card mb-4 border-0" style="background-color: #1e222b; border: 1px solid #2d323e;">
            <div class="card-header bg-transparent border-bottom border-secondary">
                <h5 class="text-white mb-0"><i class="bi bi-credit-card text-primary me-2"></i>Fee Status</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <p class="text-muted small mb-1">Total Fees</p>
                        <h5 class="text-white">‚Çπ{{ progress.total_fees }}</h5>
                    </div>
                    <div class="col-md-4">
                        <p class="text-muted small mb-1">Paid Amount</p>
                        <h5 class="text-success">‚Çπ{{ progress.paid_amount }}</h5>
                    </div>
                    <div class="col-md-4">
                        <p class="text-muted small mb-1">Remaining</p>
                        <h5 class="text-danger">‚Çπ{{ progress.get_remaining_fees }}</h5>
                    </div>
                </div>
                <div class="progress mb-2" style="height: 20px; background-color: #2d323e;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ progress.get_fee_percentage }}%;">
                        <span class="fw-bold">{{ progress.get_fee_percentage }}% Paid</span>
                    </div>
                </div>
                {% if progress.get_remaining_fees > 0 %}
                    <p class="text-muted small mb-0 text-center">You have ‚Çπ{{ progress.get_remaining_fees }} remaining to pay</p>
                {% else %}
                    <p class="text-success small mb-0 text-center"><i class="bi bi-check-circle"></i> All fees paid!</p>
                {% endif %}
            </div>
        </div>

        <!-- RHCSA/RHCE Topics Tracker -->
        <div class="card mb-4 border-0" style="background-color: #1e222b; border: 1px solid #2d323e;">
            <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center">
                <h5 class="text-white mb-0"><i class="bi bi-list-check text-success me-2"></i>Linux RHCSA/RHCE Topics</h5>
                <span class="badge bg-info" id="topicProgress">0/30 Complete</span>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 20px; background-color: #2d323e;">
                    <div class="progress-bar bg-success" id="progressBar" role="progressbar" style="width: 0%;">
                        <span id="progressText" class="fw-bold">0%</span>
                    </div>
                </div>
                <div class="text-center mb-3">
                    <button class="btn btn-outline-light btn-sm" onclick="toggleTopics()" id="toggleBtn">
                        <i class="bi bi-chevron-down" id="toggleIcon"></i> Show Topics
                    </button>
                </div>
                <div class="row" id="topicsList" style="display: none;">
                    <!-- Topics will be dynamically loaded here -->
                </div>
            </div>
        </div>

        {% if enrollments %}
            {% for enrollment in enrollments %}
            <div class="card mb-3 border-0" style="background-color: #1e222b;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="card-title text-white mb-0">{{ enrollment.course.title }}</h5>
                        
                        {% if enrollment.payment_status == 'PAID' %}
                            <span class="badge bg-success">Active / Paid</span>
                        {% elif enrollment.payment_status == 'PENDING' %}
                            <span class="badge bg-warning text-dark">Payment Pending</span>
                        {% else %}
                            <span class="badge bg-danger">Payment Failed</span>
                        {% endif %}
                    </div>
                    
                    <p class="text-muted small mb-2">{{ enrollment.course.duration }} ‚Ä¢ Price: ‚Çπ{{ enrollment.course.price }}</p>
                    
                    {% if enrollment.payment_status == 'PAID' %}
                        <div class="progress" style="height: 8px; background-color: #2d323e;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 10%;"></div>
                        </div>
                        <div class="mt-2 text-end text-muted small">10% Complete</div>
                        <a href="#" class="btn btn-sm btn-primary mt-3">Continue Learning</a>
                    {% else %}
                        <div class="alert alert-warning py-2 mt-3 mb-0 small">
                            <i class="bi bi-exclamation-triangle"></i> Access restricted. Please complete payment.
                        </div>
                        <a href="#" class="btn btn-sm btn-success mt-2">Pay Now</a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center p-5 rounded" style="background-color: #1e222b; border: 1px dashed #2d323e;">
                <h5 class="text-white">No courses yet</h5>
                <p class="text-muted">You haven't enrolled in any courses.</p>
                <a href="/" class="btn btn-primary">Browse Courses</a>
            </div>
        {% endif %}
    </div>
</div>

<div class="row mt-4 mb-5">
    <div class="col-12">
        <div class="card border-0" style="background-color: #1e222b; border: 1px solid #2d323e;">
            <div class="card-header bg-transparent border-bottom border-secondary">
                <h5 class="text-white mb-0"><i class="bi bi-chat-left-quote text-warning me-2"></i>Share Your Feedback</h5>
            </div>
            <div class="card-body">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
                
                <form method="post" action="{% url 'submit_feedback' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label text-white">Rating</label>
                        <div class="d-flex gap-2">
                            <input type="radio" class="btn-check" name="rating" id="star1" value="1">
                            <label class="btn btn-outline-warning" for="star1">‚≠ê</label>
                            
                            <input type="radio" class="btn-check" name="rating" id="star2" value="2">
                            <label class="btn btn-outline-warning" for="star2">‚≠ê‚≠ê</label>
                            
                            <input type="radio" class="btn-check" name="rating" id="star3" value="3">
                            <label class="btn btn-outline-warning" for="star3">‚≠ê‚≠ê‚≠ê</label>
                            
                            <input type="radio" class="btn-check" name="rating" id="star4" value="4">
                            <label class="btn btn-outline-warning" for="star4">‚≠ê‚≠ê‚≠ê‚≠ê</label>
                            
                            <input type="radio" class="btn-check" name="rating" id="star5" value="5" checked>
                            <label class="btn btn-outline-warning" for="star5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="message" class="form-label text-white">Your Feedback</label>
                        <textarea class="form-control" id="message" name="message" rows="4" placeholder="Share your experience with us..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-send"></i> Submit Feedback
                    </button>
                </form>
                
                {% if user_feedbacks %}
                    <div class="mt-4">
                        <h6 class="text-white mb-3">Your Previous Feedback</h6>
                        {% for feedback in user_feedbacks %}
                            <div class="card mb-2 bg-dark border-secondary">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="text-warning">{% for i in "12345"|slice:":"|make_list %}{% if forloop.counter <= feedback.rating %}‚≠ê{% endif %}{% endfor %}</span>
                                            <span class="text-muted small ms-2">{{ feedback.created_at|date:"M d, Y" }}</span>
                                            {% if feedback.is_approved %}
                                                <span class="badge bg-success ms-2">Approved</span>
                                            {% else %}
                                                <span class="badge bg-secondary ms-2">Pending</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <p class="text-white small mb-0 mt-1">{{ feedback.message }}</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-5 mb-5">
    <div class="col-12">
        <div class="card border-0 shadow-lg" style="background-color: #1e222b;">
            <div class="card-header border-0 bg-transparent text-white pt-4 px-4 d-flex justify-content-between align-items-center">
                <h3 class="mb-0"><i class="bi bi-controller me-2 text-info"></i>DevOps Career Snake</h3>
                <span class="badge bg-secondary" id="scoreBoard">Skills Mastered: 0</span>
            </div>
            <div class="card-body text-center position-relative p-4">
                
                <div id="startScreen">
                    <p class="text-muted">Eat the tech skills (AWS, Python, RHCSA) to grow your career!</p>
                    <button class="btn btn-success btn-lg px-5" onclick="startGame()">
                        <i class="bi bi-play-fill"></i> Start Game
                    </button>
                    <div class="mt-3 text-secondary small">Use Arrow Keys to Move</div>
                </div>

                <canvas id="gameCanvas" width="800" height="400"></canvas>
                
                <h5 id="targetLabel" class="mt-3 text-info" style="display:none;">Next Goal: <span class="fw-bold">AWS</span></h5>
            </div>
        </div>
    </div>
</div>

<script>
    // --- RHCSA/RHCE TOPICS TRACKER ---
    const rhcsaTopics = [
        "Understanding and Using Essential Tools",
        "File System Navigation (cd, ls, pwd)",
        "File Management (cp, mv, rm, touch)",
        "File Permissions and Ownership (chmod, chown)",
        "Text Processing (grep, sed, awk, cut)",
        "I/O Redirection and Pipes",
        "Archive and Compress (tar, gzip, bzip2)",
        "User and Group Management",
        "Process Management (ps, top, kill)",
        "Service Management (systemctl)",
        "Network Configuration (nmcli, ip)",
        "Firewall Configuration (firewalld)",
        "SELinux Basics",
        "File System Management (fdisk, mkfs)",
        "Logical Volume Management (LVM)",
        "Mount and Unmount File Systems",
        "Swap Space Configuration",
        "Job Scheduling (cron, at)",
        "Kernel Boot Parameters",
        "Package Management (yum, dnf, rpm)",
        "SSH Configuration and Key Management",
        "System Logging (journalctl, rsyslog)",
        "Bash Scripting Basics",
        "Environment Variables",
        "Shell History and Aliases",
        "Find Command and Locate",
        "Software RAID Configuration",
        "NFS and Autofs",
        "Container Management (Podman)",
        "Performance Tuning and Monitoring"
    ];

    // Load existing progress from server (prioritize server data over localStorage)
    let serverProgress = {{ topics_json|safe }};
    if (!serverProgress || typeof serverProgress !== 'object') {
        serverProgress = {};
    }

    function loadTopics() {
        const topicsList = document.getElementById('topicsList');
        // Use server data directly (admin updates are reflected here)
        const savedTopics = serverProgress;

        topicsList.innerHTML = ''; // Clear existing

        rhcsaTopics.forEach((topic, index) => {
            const isChecked = savedTopics[index] || false;
            const col = document.createElement('div');
            col.className = 'col-md-6 mb-2';
            
            col.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="topic${index}" 
                           ${isChecked ? 'checked' : ''} disabled>
                    <label class="form-check-label text-white small" for="topic${index}">
                        ${topic}
                    </label>
                </div>
            `;
            topicsList.appendChild(col);
        });

        updateProgress();
    }

    function toggleTopics() {
        const topicsList = document.getElementById('topicsList');
        const toggleBtn = document.getElementById('toggleBtn');
        const toggleIcon = document.getElementById('toggleIcon');
        
        if (topicsList.style.display === 'none') {
            topicsList.style.display = 'flex';
            toggleBtn.innerHTML = '<i class="bi bi-chevron-up" id="toggleIcon"></i> Hide Topics';
        } else {
            topicsList.style.display = 'none';
            toggleBtn.innerHTML = '<i class="bi bi-chevron-down" id="toggleIcon"></i> Show Topics';
        }
    }

    function updateProgress() {
        const checkboxes = document.querySelectorAll('#topicsList input[type="checkbox"]');
        let completed = 0;
        const savedTopics = {};

        checkboxes.forEach((checkbox, index) => {
            if (checkbox.checked) {
                completed++;
                savedTopics[index] = true;
            } else {
                savedTopics[index] = false;
            }
        });

        const total = rhcsaTopics.length;
        const percentage = Math.round((completed / total) * 100);

        // Update UI
        document.getElementById('topicProgress').innerText = `${completed}/${total} Complete`;
        document.getElementById('progressBar').style.width = percentage + '%';
        document.getElementById('progressText').innerText = percentage + '%';
    }

    // Load topics on page load
    document.addEventListener('DOMContentLoaded', loadTopics);

    // --- GAME CONFIGURATION ---
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startScreen = document.getElementById("startScreen");
    const scoreBoard = document.getElementById("scoreBoard");
    const targetLabel = document.getElementById("targetLabel");

    const gridSize = 20;
    const tileCountX = canvas.width / gridSize;
    const tileCountY = canvas.height / gridSize;

    // The "Food" List - DevOps Skills
    const techStack = [
        "AWS", "Linux", "Python", "Docker", "K8s", "Jenkins", 
        "Terraform", "Ansible", "Git", "Azure", "GCP", "RHCSA", "RHCE"
    ];

    let score = 0;
    let techIndex = 0;
    
    let snake = [];
    let food = { x: 15, y: 15 };
    let dx = 0;
    let dy = 0;
    let gameInterval;
    let isGameRunning = false;

    function startGame() {
        // Reset Game State
        snake = [{ x: 10, y: 10 }, { x: 9, y: 10 }, { x: 8, y: 10 }];
        score = 0;
        techIndex = 0;
        dx = 1; // Start moving right
        dy = 0;
        isGameRunning = true;
        
        // UI Updates
        startScreen.style.display = "none";
        canvas.style.display = "block";
        targetLabel.style.display = "block";
        scoreBoard.innerText = "Skills Mastered: 0";
        updateTargetLabel();

        spawnFood();

        if (gameInterval) clearInterval(gameInterval);
        gameInterval = setInterval(gameLoop, 100); // 100ms = Game Speed
    }

    function gameLoop() {
        if(!isGameRunning) return;

        // Move Snake
        const head = { x: snake[0].x + dx, y: snake[0].y + dy };

        // Wall Collision (Game Over)
        if (head.x < 0 || head.x >= tileCountX || head.y < 0 || head.y >= tileCountY) {
            gameOver();
            return;
        }

        // Self Collision (Game Over)
        for (let i = 0; i < snake.length; i++) {
            if (head.x === snake[i].x && head.y === snake[i].y) {
                gameOver();
                return;
            }
        }

        snake.unshift(head); // Add new head

        // Eat Food
        if (head.x === food.x && head.y === food.y) {
            score++;
            techIndex = (techIndex + 1) % techStack.length; // Cycle through skills
            scoreBoard.innerText = "Skills Mastered: " + score;
            updateTargetLabel();
            
            // Check if player reached 10 points
            if (score >= 5) {
                gameWin();
                return;
            }
            
            spawnFood();
            // Don't pop the tail, so snake grows
        } else {
            snake.pop(); // Remove tail if no food eaten
        }

        draw();
    }

    function draw() {
        // Clear Screen
        ctx.fillStyle = "#0f1115";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw Snake
        ctx.fillStyle = "#0d6efd"; // Blue Snake
        for (let i = 0; i < snake.length; i++) {
            // Make head lighter color
            ctx.fillStyle = (i === 0) ? "#00d4ff" : "#0d6efd";
            ctx.fillRect(snake[i].x * gridSize, snake[i].y * gridSize, gridSize - 2, gridSize - 2);
        }

        // Draw Food (The Tech Skill)
        ctx.fillStyle = "#198754"; // Green Food
        ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
        
        // Draw Text near food
        ctx.fillStyle = "#ffffff";
        ctx.font = "12px Arial";
        ctx.fillText(techStack[techIndex], (food.x * gridSize) - 10, (food.y * gridSize) - 5);
    }

    function spawnFood() {
        food.x = Math.floor(Math.random() * tileCountX);
        food.y = Math.floor(Math.random() * tileCountY);
        
        // Ensure food doesn't spawn on snake body
        for (let part of snake) {
            if (part.x === food.x && part.y === food.y) spawnFood();
        }
    }

    function updateTargetLabel() {
        // Update the text below the canvas
        targetLabel.innerHTML = `Next Goal: <span class="fw-bold text-white">${techStack[techIndex]}</span>`;
    }

    function gameOver() {
        isGameRunning = false;
        clearInterval(gameInterval);
        
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "white";
        ctx.font = "30px Arial";
        ctx.fillText("Game Over!", canvas.width / 2 - 80, canvas.height / 2);
        ctx.font = "20px Arial";
        ctx.fillText("Score: " + score, canvas.width / 2 - 40, canvas.height / 2 + 40);

        setTimeout(() => {
            canvas.style.display = "none";
            targetLabel.style.display = "none";
            startScreen.style.display = "block";
        }, 2000);
    }

    function gameWin() {
        isGameRunning = false;
        clearInterval(gameInterval);
        
        ctx.fillStyle = "rgba(0,0,0,0.8)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#00d4ff";
        ctx.font = "bold 36px Arial";
        ctx.fillText("Congratulations! üéâ", canvas.width / 2 - 160, canvas.height / 2 - 30);
        ctx.fillStyle = "white";
        ctx.font = "24px Arial";
        ctx.fillText("Go back to studies :D", canvas.width / 2 - 140, canvas.height / 2 + 20);

        setTimeout(() => {
            canvas.style.display = "none";
            targetLabel.style.display = "none";
            startScreen.style.display = "block";
        }, 3000);
    }

    // Keyboard Controls
    document.addEventListener("keydown", (event) => {
        // Prevent scrolling with arrows
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(event.code) > -1) {
            event.preventDefault();
        }

        if (!isGameRunning) return;

        switch (event.key) {
            case "ArrowUp":
                if (dy !== 1) { dx = 0; dy = -1; }
                break;
            case "ArrowDown":
                if (dy !== -1) { dx = 0; dy = 1; }
                break;
            case "ArrowLeft":
                if (dx !== 1) { dx = -1; dy = 0; }
                break;
            case "ArrowRight":
                if (dx !== -1) { dx = 1; dy = 0; }
                break;
        }
    });
</script>
{% endblock %}